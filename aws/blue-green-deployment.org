#+Title: Blue Green Deployment of Services
#+Author: Yogesh Agrawal
#+Email: yogeshiiith@gmail.com
#+Date: <2017-01-10 Tue>

* Introduction
  Blue Green Deployment of services.

* Blue/Green Deployment Methodology
  - Blue/Green deployment is a technique for releasing applications by
    shifting traffic between two identical environments running
    different versions of the application. Blue/Green deployments
    provide near zero-downtime relase and rollback capabilities.

  - After the green environment is ready and tested, production
    traffic is redirected from blue to green. If any problems are
    identified, we can roll back by reverting traffic back to the blue
    environment.

    [[./blue-green-deployment.jpg]]

  - Blue/Green deployment isn't a new concept, we don't commonly see
    it used in traditional, on-premises hosted environment due to the
    cost and effort required to provision additional resources.

** Benefits of Blue/Green
   - It ensures spinning up a parallel green environment, does not
     affect resources and underpinning your blue environment.

   - After we deploy the green environment we have the opportunity to
     validate it. We can do that with the test traffic before sending
     production traffic to the green environment, or by using a very
     small fraction of production traffic, to better reflect real user
     traffic. This is called *canary analysis* or *canary testing*. If
     we discover the green environment is not operating as expected,
     there is no impact on the blue environment. We can route traffic
     back to it, minimizing impaired operation or downtime, and
     limiting the blast radius of impact.

   - Once the deployment succeeds, we decommission the blue
     environment and stop paying for the resources it was using.

** Factors Affecting the deployment
   |--------------------------+--------------------------------|
   | *Factors                 | Criteria*                      |
   |--------------------------+--------------------------------|
   | Application Architecture | Dependencies                   |
   |--------------------------+--------------------------------|
   | Organizational           | Speed and number of iterations |
   |--------------------------+--------------------------------|
   | Risk and complexity      | Impact of failed radius        |
   |--------------------------+--------------------------------|
   | People                   | Expertise                      |
   |--------------------------+--------------------------------|
   | Process                  | Testing/QA                     |
   |--------------------------+--------------------------------|
   | Cost                     | Operating budget               |
   |--------------------------+--------------------------------|

* AWS Tools and Services Enabling Blue/Green Deployments
** Amazon Route 53
   DNS is a classic approach to blue/green deployments, allowing
   administrators to direct traffic by simply updating DNS records in
   the hosted zone. 
   
   Also, time to live (TTL) can be adjusted for resource records, a
   shorter TTL allows record changes to propogate faster to clients.

** Elastic Load Balancing
   ELB distributes incoming application traffic across designated EC2
   instances. ELB scales in response to incoming requests, performs
   health checking against EC2 resources, and naturally integrates
   with other AWS tools, such as auto scaling.
** Auto Scaling
   Auto Scaling helps maintain application availability and lets
   customers scale EC2 capacity up or down automatically according to
   defined conditions. The templates used to launch EC2 instances in
   an auto scaling group are called launch configurations. We can
   attach different versions of auto scaling group to enable
   blue/green deployment. We can also configure Auto Scaling for use
   with an Elastic Load Balancing load balancer. In this configuration
   ELB balances the traffic across the EC2 instances running in an
   Auto Scaling group.

   Auto scaling also allows instances to be placed in a Standby state,
   instead of termination, which helps quick rollback when required.

** AWS Elastic Beanstalk
   Elastic Beanstalk supports Auto Scaling and Elastic Load Balancing,
   both of which enable blue/green deployment. Elastic Beanstalk makes
   it easy to run multiple versions of application and provides
   capabilities to swap the environment URLs, facilitating blue/gree
   deployment.

* Techniques
** Update DNS routing
   DNS is the mechanism for switching traffic from the blue
   environment to the green and vice versa, if rollback is necessary.

   This technique applies to environments that are:
   - Single instances, with a public or Elastic IP address
   - Group of instances behind an ELB
   - Instances in an Auto Scaling group with an ELB as the front end
   - Elastic Beanstalk environment

   We can shift traffic all at once or we can do a weighted
   distribution. With Route53 we can define a percentage of traffic to
   go to the green environment and gradually update the weights until
   the green environment carries the full production traffic. A
   weighted distribution provides the ability to perform canary
   analysis where a small percentage of production traffic is
   introduced to a new environment.

   [[./blue-green-deployment-weighted-dns.jpg]]
   
   If issues arise during the deployment, we achive rollback by
   updating the DNS record to shift traffic back to the blue
   environment. Although DNS routing is simple to implement for
   blue/green, the question is how quickly we can complete a
   rollback. *DNS TTL* determines how long clients cache query
   results. However, with older clients and potentially misbehaving
   clients in the wild, certain sessions may still be tied to the
   previous environment.
   
   For a full cutover, be sure to tune Auto Scaling policy to scale as
   expected and remember that the new ELB endpoint may need time to
   scale up as well.

** Swap the Auto Scaling Group Behind Elastic Load Balancer
   This technique uses ASG to manage the EC2 resources for our blue
   and green environments, scaling up or down based on actual demand.

   Auto Scaling integrates with ELB, so any new instances are
   automatically added to the load balancing pool if they pass the
   health checks governed by the load balancer.

   ELB tests the health of our registered EC2 instances with a simple
   ping or a more sophisticated connection attempt or request.

   We could have an ELB health check ploicy that pings port 80 every
   20 seconds and, after passing a threshold of 10 successful pings,
   reports the instance, reports the instance as being InService. If
   enough ping requests time out, then the instance is reported to be
   OutOfService.

   For scale-down activities, the load balancer removes the EC2
   instance from the pool and drains current connections before they
   terminate.

   [[./blue-green-deployment-asg-state-1.jpg]]

   A blue group carries the production load while a green group is
   staged and deployed with the new code. When it's time to deploy, we
   simply attach the green group to the existing load balancer to
   introduce traffic to the new environment.

   [[./blue-green-deployment-asg-state-2.jpg]]

   As we scale up the green Auto Scaling group, we can take blue Auto
   Scaling group instances out of service by either terminating them
   by either terminating them or putting them in Standby
   state. Standby is a good option because if we need to roll back to
   the blue environment, we only have to put our blue server instances
   back in service and they are ready to go. As soon as the green
   group is scaled up without issues, we can decommission the blue
   group by adjusting the group size to zero. If we need to rollback,
   detach the load balancer from the gree group or reduce the group
   size of the green group to zero.


* References
  - https://www.thoughtworks.com/insights/blog/implementing-blue-green-deployments-aws
  - https://d0.awsstatic.com/whitepapers/AWS_Blue_Green_Deployments.pdf
  - http://www.spinnaker.io/
  - http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.CNAMESwap.html
  - https://aws.amazon.com/answers/web-applications/aws-web-app-deployment-java/
  - http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_Java.html
  - http://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/how-elastic-load-balancing-works.html
